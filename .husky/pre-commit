#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# --- Configuration ---
README_FILE="README.md" # The file to check and process with doctoc
COMMIT_MESSAGE="docs: auto-update README TOC" # Commit message for automatic TOC updates

# --- Script Logic ---

# Check if README_FILE has staged changes.
if ! git diff --cached --quiet --exit-code -- "${README_FILE}"; then
  # This block executes if README_FILE HAS staged changes.
  echo "Husky: Checking staged changes in ${README_FILE} for TOC consistency..."

  STAGED_DIFF_CONTENT=$(git diff --cached -- "$README_FILE" | sed '1,4d' 2>/dev/null || true)
  STAGED_CHANGES_OUTSIDE_TOC=$(echo "$STAGED_DIFF_CONTENT" | sed '/<!-- START doctoc/,/<!-- END doctoc/d' | grep '^\+' || true)

  if [ -n "$STAGED_CHANGES_OUTSIDE_TOC" ]; then
    echo "Husky: Staged changes detected in ${README_FILE} outside of the TOC section."
    echo "Husky: Running 'npm run doctoc-readme' to update the TOC..."

    npm run doctoc-readme

    # Check if `doctoc-readme` modified the README_FILE in the working directory
    # (compared to what's in the index/staging area before doctoc ran).
    # `git diff --quiet "$README_FILE"` returns 1 (false) if differences exist in the working dir vs index.
    if ! git diff --quiet "$README_FILE"; then # True if README_FILE in working dir differs from index (i.e., doctoc changed it)
      echo "Husky: 'npm run doctoc-readme' has modified ${README_FILE}."
      echo "Husky: Staging these changes and creating a separate commit for TOC update."
      git add "$README_FILE"
      # Create a new commit for the TOC changes.
      # Use --no-verify to prevent this hook from running recursively on this commit.
      git commit --no-verify -m "$COMMIT_MESSAGE"
      if [ $? -eq 0 ]; then
        echo "Husky: TOC update committed with message: '$COMMIT_MESSAGE'."
      else
        echo "Husky: ERROR - Failed to commit TOC update. Please check for errors."
        # Optionally, exit 1 here if a failed auto-commit should block the original commit.
        # For now, we'll let the original commit proceed even if the auto-TOC commit fails.
      fi
      echo "Husky: Proceeding with original commit."
    else
      echo "Husky: 'npm run doctoc-readme' ran. No further changes were made to ${README_FILE} or it was already up-to-date."
    fi
  else
    echo "Husky: No staged changes detected in ${README_FILE} outside of the TOC section. TOC is consistent."
  fi
else
  echo "Husky: ${README_FILE} not staged or no staged changes. Skipping TOC check."
fi

# If we reach here, the original commit is allowed to proceed.
exit 0
