import e,{useState as t,useEffect as n,useRef as o,createContext as i,useContext as r}from"react";import c from"@constructor-io/constructorio-client-javascript";import{useCombobox as l}from"downshift";let a=0;const s=(e,o,i)=>{const[r,c]=t({}),l=((e,o=250)=>{const[i,r]=t(e);return n((()=>{const t=setTimeout((()=>{r(e)}),o);return()=>{clearTimeout(t)}}),[e,o]),i})(e),a={resultsPerSection:{}};return i&&(a.resultsPerSection=i.reduce(((e,t)=>{var n;return{...e,[t.identifier]:(null===(n=null==t?void 0:t.parameters)||void 0===n?void 0:n.numResults)||8}}),{})),n((()=>{l?null==o||o.autocomplete.getAutocompleteResults(l,a).then((e=>{const t={};Object.keys(e.sections).forEach((n=>{t[n]=e.sections[n].map((e=>({...e,section:n})))})),c(t)})):l||c({})}),[l,o]),r},u=[{identifier:"Search Suggestions",type:"autocomplete"},{identifier:"Products",type:"autocomplete"}],d=e=>{const i="What can we help you find today?",{onSubmit:r,onChange:d,openOnFocus:m,apiKey:p,cioJsClient:g,placeholder:v=i,sections:f=u,zeroStateSections:h}=e,[x,y]=t(""),b=(e=>{const t=o();return n((()=>{t.current=e}),[e]),t.current})(x),E=(({apiKey:e,cioJsClient:o})=>{const[i,r]=t(o);return n((()=>{if(e&&!o){const t=new c({apiKey:e,sendTrackingEvents:!0});r(t)}else o&&r(o)}),[e,o]),i})({apiKey:p,cioJsClient:g}),w=!x.length&&h;let P=w?h:f;f&&!Array.isArray(f)&&(console.error("useCioAutocomplete expects sections to reference an array of section configuration objects"),P=[]),h&&!Array.isArray(h)&&(console.error("useCioAutocomplete expects zeroStateSections to reference an array of section configuration objects"),P=[]);const S=null==P?void 0:P.filter((e=>"autocomplete"===e.type||!e.type)),C=null==P?void 0:P.filter((e=>"recommendations"===e.type)),I=s(x,E,S),k=((e,o)=>{const[i,r]=t({});return n((()=>{e&&Array.isArray(o)&&0!==o.length&&(async()=>{const t=await Promise.all(o.map((({identifier:t,parameters:n})=>e.recommendations.getRecommendations(t,n)))),n={};t.forEach((({response:e})=>{const{pod:t,results:o}=e;(null==t?void 0:t.id)&&(n[t.id]=null==o?void 0:o.map((e=>({...e,section:t.id}))))})),r(n)})()}),[e]),i})(E,C),N={...I,...k},A=[];null==P||P.forEach((e=>{const{identifier:t,data:n}=e,o=N[t]||n;o&&void 0!==o&&A.push({...e,data:o})}));const F=[];null==A||A.forEach((e=>{(null==e?void 0:e.data)&&F.push(...e.data)}));const M=(({setQuery:e,items:t,onSubmit:n,cioClient:o,previousQuery:i="",onChange:r})=>l({id:"cio-autocomplete-"+a++,items:t,itemToString:e=>(null==e?void 0:e.value)||"",onInputValueChange:async({inputValue:t=""})=>{e(t),r&&r(t)},onSelectedItemChange({selectedItem:t}){var r;t&&(e(t.value||""),(null==t?void 0:t.value)&&(n&&n({item:t,originalQuery:i}),(null===(r=null==t?void 0:t.data)||void 0===r?void 0:r.url)||null==o||o.tracker.trackSearchSubmit(t.value,{original_query:i}),null==o||o.tracker.trackAutocompleteSelect(t.value,{original_query:i,section:t.section})))}}))({setQuery:y,onChange:d,items:F,onSubmit:r,cioClient:E,previousQuery:b}),{isOpen:Q,getMenuProps:z,getLabelProps:T,openMenu:q,closeMenu:L,getComboboxProps:_}=M;return{query:x,sections:A,isOpen:Q,getMenuProps:()=>({...z(),className:"cio-results","data-testid":"cio-results"}),getLabelProps:T,openMenu:q,closeMenu:L,getItemProps:({item:e,index:t=0,sectionIdentifier:n="Products"})=>{const o=(({activeSections:e,sectionIdentifier:t})=>{let n=0;return t&&e.find((e=>{var o;return(null==e?void 0:e.identifier)===t||(n+=(null===(o=null==e?void 0:e.data)||void 0===o?void 0:o.length)||0,!1)})),n})({activeSections:A,sectionIdentifier:n});return{...M.getItemProps({item:e,index:t+o}),className:"cio-item","data-testid":`cio-item-${n.replace(" ","")}`}},getInputProps:()=>({...M.getInputProps(),value:x,onFocus:()=>{var t;e.onFocus&&e.onFocus(),w&&!1!==m&&M.openMenu(),null===(t=null==E?void 0:E.tracker)||void 0===t||t.trackInputFocus()},className:"cio-input","data-testid":"cio-input",placeholder:v}),getFormProps:()=>({..._(),onSubmit:e=>(e.preventDefault(),r&&r({query:x}),null==E||E.tracker.trackSearchSubmit(x,{original_query:x}),{query:x}),className:"cio-form","data-testid":"cio-form"}),setQuery:y,cioClient:E}},m=i({});function p(t){const{children:n,...o}=t,i=d(o);return e.createElement(m.Provider,{value:{...i}},e.createElement("div",{className:"cio-autocomplete"},n))}function g(t){var n;const{item:o,index:i,sectionIdentifier:c,children:l}=t,{getItemProps:a}=r(m);let s;return s=function(e){return void 0!==e.data.image_url}(o)?e.createElement(e.Fragment,null,e.createElement("img",{"data-testid":"cio-img",src:null===(n=o.data)||void 0===n?void 0:n.image_url,alt:o.value}),e.createElement("p",{"data-testid":"cio-text"},o.value)):o.value,e.createElement("li",{...a({item:o,index:i,sectionIdentifier:c}),className:"cio-item"},l||s)}function v(e){const{section:t,children:n=f}=e;return n({section:t})}const f=({section:t})=>{var n;const o=(null==t?void 0:t.displayName)||(null==t?void 0:t.identifier);return e.createElement("li",{className:`${o} cio-section`},e.createElement("h5",{className:"cio-sectionName"},o.replace(/([A-Z])/g," $1").replace(/^./,(function(e){return e.toUpperCase()}))),e.createElement("ul",{className:"cio-items"},null===(n=null==t?void 0:t.data)||void 0===n?void 0:n.map(((n,o)=>{var i;return e.createElement(g,{item:n,index:o,sectionIdentifier:null==t?void 0:t.identifier,key:`${null==t?void 0:t.identifier}_${null===(i=null==n?void 0:n.data)||void 0===i?void 0:i.id}`})}))))};function h(t){const{children:n=x}=t,{sections:o,isOpen:i,getMenuProps:c,getItemProps:l}=r(m),a=o&&o.some((e=>{var t;return null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.length}));let s;s=i&&a?"function"==typeof n?n({sections:o,getItemProps:l}):n:null;const u={...c()};return e.createElement("ul",{...u},s)}!function(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var o=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===n&&o.firstChild?o.insertBefore(i,o.firstChild):o.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".cio-autocomplete {\n  font-family: Arial, Helvetica, sans-serif;\n  padding: 20px;\n}\n\n.cio-autocomplete .cio-items {\n  padding: 0;\n}\n\n.cio-autocomplete .cio-item {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n}\n\n.cio-autocomplete .cio-item img {\n  width: 100%;\n}\n\n.cio-autocomplete .products.cio-section .cio-item {\n  align-items: center;\n  justify-content: start;\n}\n\n.cio-autocomplete .products.cio-section .cio-items {\n  display: flex;\n}\n\n.cio-autocomplete .cio-form {\n  position: relative;\n  z-index: 100;\n  width: 300px;\n  top: 0px;\n  right: -8px;\n  height: 30px;\n}\n\n.cio-autocomplete .cio-input {\n  width: 100%;\n  height: 100%;\n  border: 1px solid gray;\n  padding: 0 10px;\n  border-radius: 3px;\n}\n\n.cio-autocomplete .cio-form .cio-btn,\n.cio-autocomplete .cio-form .cio-clear-btn {\n  position: absolute;\n  top: 1px;\n  bottom: -1px;\n  right: -21px;\n}\n\n.cio-autocomplete .cio-form .cio-btn[type='submit'] {\n  right: -21px;\n}\n\n.cio-autocomplete .cio-form .cio-clear-btn {\n  right: 10px;\n}\n\n.cio-autocomplete .cio-form .cio-icon {\n  display: flex;\n}\n\n.cio-autocomplete .cio-results {\n  background-color: white;\n  gap: 20px;\n  padding-left: 0px;\n  list-style: none;\n  display: flex;\n  flex-direction: row;\n  z-index: 1000;\n}\n\n.cio-autocomplete .cio-sectionName {\n  margin: 15px 0 20px 0;\n  font-size: 22px;\n}\n\n.cio-autocomplete .cio-results .cio-section.searchSuggestions .cio-items {\n  flex-direction: column;\n  min-width: 200px;\n}\n\n.cio-autocomplete .cio-item {\n  list-style: none;\n}\n\n.cio-autocomplete .cio-item {\n  padding: 10px;\n  margin: 1px;\n  border-bottom: 3px solid transparent;\n}\n\n.cio-autocomplete .cio-item img {\n  max-width: 100px;\n}\n\n.cio-autocomplete [aria-selected='true'] {\n  background-color: hsl(0, 0%, 90%);\n  border-radius: 4px;\n}\n\n.cio-autocomplete .cio-results[role='listbox'].showing-content {\n  position: relative;\n  top: 2px;\n  left: 8px;\n  max-width: 90vw;\n  background: white;\n  margin: 0px;\n  box-shadow: 0 2px 2px 1px grey;\n  overflow: auto;\n}\n");const x=({sections:t})=>e.createElement(e.Fragment,null,null==t?void 0:t.map((t=>e.createElement(v,{section:t,key:t.identifier}))));function y(e){const{children:t=b}=e,{getFormProps:n,getInputProps:o,getLabelProps:i,setQuery:c}=r(m);return t({getFormProps:n,getInputProps:o,getLabelProps:i,setQuery:c})}const b=({getFormProps:t,getInputProps:n,getLabelProps:o,setQuery:i})=>{const r=n();return e.createElement("form",{...t()},e.createElement("label",{...o(),hidden:!0},"Search"),e.createElement("input",{...r}),e.createElement("button",{className:"cio-clear-btn","data-testid":"cio-clear-btn",hidden:!r.value,onClick:()=>{var e;i(""),r.id&&(null===(e=document.getElementById(r.id))||void 0===e||e.focus())},type:"button","aria-label":"Clear search field text"},e.createElement("div",{className:"cio-icon"},e.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:"0",viewBox:"0 0 512 512",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg"},e.createElement("path",{d:"M289.94 256l95-95A24 24 0 00351 127l-95 95-95-95a24 24 0 00-34 34l95 95-95 95a24 24 0 1034 34l95-95 95 95a24 24 0 0034-34z"})))),e.createElement("button",{className:"cio-btn","data-testid":"cio-btn",disabled:!r.value,type:"submit","aria-label":"Submit Search"},e.createElement("div",{className:"cio-icon"},e.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:"0",viewBox:"0 0 512 512",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg"},e.createElement("path",{d:"M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"})))))};function E(t){const{children:n}=t;return n?e.createElement(p,{...t},n):e.createElement("div",null,e.createElement(p,{...t},e.createElement(y,null),e.createElement(h,null)))}export{h as AutocompleteResults,E as CioAutocomplete,y as SearchInput,g as SectionItem,v as SectionItemsList,d as useCioAutocomplete};
//# sourceMappingURL=index.js.map
